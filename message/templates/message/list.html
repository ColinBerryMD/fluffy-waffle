{% extends 'base.html' %}


{% block title %} Messages {% endblock %}
{% block header %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename = 'css/chat.css') }}">
{% endblock %}
{% block content %}
{# needs messages; a list of Message() #}
{# needs group = SMSGroup() #}
<div class="w3-row">
    <div id="chat_column" class="w3-col s12 m8 l8">

        <div id="tab_parent" class="w3-container w3-bar cb-under-navbar">
            {% if messages %}
                {% for sender, their_messages in messages | groupby('sms_client.id') %}
                    {% with client = their_messages[0].sms_client %}
                        <button id="button_{{ sender }}" 
                            {% if loop.index == 1 %}
                                class="w3-bar-item w3-left w3-block tablink active" 
                            {% else %}
                                class="w3-bar-item w3-left w3-block tablink" 
                            {% endif %}
                                onclick="openTab(event, 'chat_column', 'sms_{{ sender }}')" >
                            {{ client.firstname }}&nbsp{{ client.lastname }}
                        </button>
                    {% endwith %}
                {% endfor %}
            {% else %}
                <h1 class='w3-padding-16 w3-center cb-under-navbar'>No Messages</h1>
            {% endif %}
        </div>

        <div id="chat_parent" class="w3-container">
            {% if messages %}
                {% for sender, their_messages in messages | groupby('sms_client.id') %}
                    <div id="sms_{{ sender }}" class="w3-container tabcontent"
                        {% if loop.index == 1 %}
                            style="display: block;"
                        {% else %}
                            style ="display:none;"
                        {% endif %}>
                        {% for m in their_messages %}
                            {% if m.Outgoing %}
                            <div id="chat_child" class="chat-container chat-outgoing">
                                <p>{{ m.Body }}</p>
                                <span class="chat-time-right">{{ m.SentAt }}</span>
                            </div>
                            {% else %}
                            <div id="chat_child" class="chat-container chat-incoming">
                                <p>{{ m.Body }}</p>
                                <span class="chat-time-left">{{ m.SentAt }}</span>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                    <div id="chat_placeholder" class="chat-container chat-incoming">
                        <p >No messages yet.</p>
                    </div> 
            {% endif%}
        </div>
    </div>
    {% if group %}
    <div id="group_column" class="w3-col s12 m4 l4 cb-under-navbar">
        <div id="group_parent" class="w3-container w3-bar">
            <button id="button_list" 
                    class="w3-bar-item w3-left w3-block tablink active" 
                    onclick="openTab(event,'group_column','group_list')" >
                {{ group.name }}
            </button>
            <button id="button_multiple" 
                    class="w3-bar-item w3-left w3-block tablink" 
                    onclick="openTab(event,'group_column','group_multiple')" >
                Multiple
            </button>
            <button id="button_other_client" 
                    class="w3-bar-item w3-left w3-block tablink" 
                    onclick="openTab(event,'group_column','group_other_client')" >
                Other Client
            </button>
        </div>
        <div id="group_list" class="w3-container tabcontent" style="display: block;">
        {% for member in group.clients %}
            <div class="w3-container">
                <a class="open-chat-popup" onclick="chatPopup('chatForm_{{member.id}}')">
                        {{ member.firstname }}&nbsp{{ member.lastname }}
                        <i class='far fa-comment' style='font-size:24px'></i>
                </a>
            </div>
            <div class="chat-popup w3-container" id="chatForm_{{member.id}}" 
                 style="display: none;">
                <span onclick="closePopup('chatForm_{{member.id}}')"
                      class="w3-large w3-button w3-display-topright">&times;</span>
                <form action="{{ url_for('message.send', client_id = member.id) }}" 
                      method="post">
                    <textarea class="w3-input" placeholder="Type message..." name="Body" required></textarea>
                    <div class="w3-bar w3-padding-16">
                        <button type='submit' class="w3-button" 
                                onclick="closePopup('chatForm_{{member.id}}')">Send</button>
                    </div>
                </form>
            </div>
        {% endfor %}
        </div>
        <div id="group_multiple" class="w3-container tabcontent" style="display: none;">
            <form action="{{ url_for('message.multiple_send') }}" method="post">
                <ul style="list-style-type: none">
            {% for member in group.clients %}
                    <li>
                        <label for="check_{{member.id}}">{{ member.firstname }}&nbsp{{ member.lastname }}</label>
                        <input type="checkbox" id="check_{{member.id}}" name="selected" value="{{member.id}}" checked/>
                    </li>
            {% endfor %}
                </ul>
                <div class="chat-popup" style="display: block;">
                    <textarea class="w3-input" placeholder="Type message..." name="MultiBody" required></textarea>
                    <div class="w3-bar w3-padding-16">
                        <button type='reset' class="w3-button" >Reset</button>
                        <button type='submit' class="w3-button">Send </button>
                    </div>
                </div>
            </form>
        </div>
        <div id="group_other_client" class="w3-container tabcontent" style="display: none;">
            <h2>select from outside of group</h2>
        </div>
    </div>
    {% endif %}
{% endblock %}